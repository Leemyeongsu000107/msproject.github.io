import java.io.*;
import java.net.ServerSocket;
import java.net.Socket;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Path;

public class NetworkHttpServer {
    public static void main(String[] args) {
        try (ServerSocket serverSocket = new ServerSocket(8080)) {
            System.out.println("[WebServer is ready]");

            while (true) {
                try (Socket socket = serverSocket.accept()) {
                    BufferedReader br = new BufferedReader(new InputStreamReader(socket.getInputStream()));
                    BufferedWriter bw = new BufferedWriter(new OutputStreamWriter(socket.getOutputStream(), StandardCharsets.UTF_8));

                    String request = br.readLine();
                    if (request != null && request.startsWith("GET")) {
                        String[] tokens = request.split(" ");
                        String path = tokens[1].substring(1); // Remove leading slash

                        if (path.isEmpty()) {
                            path = "index.html"; // Default file if no specific path is provided
                        }

                        File file = new File(path);
                        if (file.exists() && file.isFile()) {
                            String contentType = Files.probeContentType(file.toPath());
                            long contentLength = file.length();

                            bw.write("HTTP/1.1 200 OK\r\n");
                            bw.write("Content-Type: " + contentType + "\r\n");
                            bw.write("Content-Length: " + contentLength + "\r\n");
                            bw.write("\r\n");
                            bw.flush();

                            try (FileInputStream fileInputStream = new FileInputStream(file)) {
                                byte[] buffer = new byte[1024];
                                int bytesRead;

                                while ((bytesRead = fileInputStream.read(buffer)) != -1) {
                                    socket.getOutputStream().write(buffer, 0, bytesRead);
                                }
                            }
                        } else {
                            String errorMessage = "404 Not Found";
                            String errorResponse = "HTTP/1.1 " + errorMessage + "\r\n" +
                                    "Content-Type: text/plain\r\n" +
                                    "Content-Length: " + errorMessage.length() + "\r\n" +
                                    "\r\n" +
                                    errorMessage;

                            bw.write(errorResponse);
                            bw.flush();
                        }
                    }
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
